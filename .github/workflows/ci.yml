name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  GRADLE_VERSION: "9.3.1"
  JAVA_VERSION: "25"
  KOTLIN_VERSION: "2.3.10"
  PYTHON_VERSION: "3.13"

jobs:
  # ==========================================================================
  # Job 1: Update Templates
  # ==========================================================================
  update-templates:
    name: Update Templates
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install jinja2 toml pyyaml requests
      
      - name: Update templates
        run: |
          python gradleInit.py templates --update
      
      - name: List templates
        run: |
          python gradleInit.py templates --list

  # ==========================================================================
  # Job 2: Test Single Templates (kotlin-single, ktor, springboot, kotlin-javaFX)
  # ==========================================================================
  test-single-templates:
    name: Test ${{ matrix.template }}
    runs-on: ubuntu-latest
    needs: update-templates
    
    strategy:
      fail-fast: false
      matrix:
        template:
          - kotlin-single
          - kotlin-single-clikt
          - ktor
          - springboot
        include:
          - template: kotlin-single
            config: ""
          - template: kotlin-single-clikt
            template_name: kotlin-single
            config: "--config enable_clikt=true"
          - template: ktor
            config: ""
          - template: springboot
            config: ""
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Python dependencies
        run: pip install jinja2 toml pyyaml requests
      
      - name: Update templates
        run: python gradleInit.py templates --update
      
      - name: Generate project from template
        run: |
          TEMPLATE_NAME="${{ matrix.template_name || matrix.template }}"
          python gradleInit.py init test-${{ matrix.template }} \
            --template "$TEMPLATE_NAME" \
            --group com.example \
            ${{ matrix.config }}
      
      - name: Build and test
        working-directory: test-${{ matrix.template }}
        run: |
          chmod +x gradlew
          ./gradlew clean build test --no-daemon
      
      - name: Build with Git info
        working-directory: test-${{ matrix.template }}
        run: |
          ./gradlew clean build -PenableGitInfo=true --no-daemon

  # ==========================================================================
  # Job 3: Test kotlin-javaFX (needs display)
  # ==========================================================================
  test-javafx:
    name: Test kotlin-javaFX
    runs-on: ubuntu-latest
    needs: update-templates
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Python dependencies
        run: pip install jinja2 toml pyyaml requests
      
      - name: Update templates
        run: python gradleInit.py templates --update
      
      - name: Generate JavaFX project
        run: |
          python gradleInit.py init test-javafx \
            --template kotlin-javaFX \
            --group com.example
      
      - name: Build (no GUI tests)
        working-directory: test-javafx
        run: |
          chmod +x gradlew
          ./gradlew clean build -x test --no-daemon

  # ==========================================================================
  # Job 4: Test kotlin-multi Template
  # ==========================================================================
  test-kotlin-multi:
    name: Test kotlin-multi
    runs-on: ubuntu-latest
    needs: update-templates
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Python dependencies
        run: pip install jinja2 toml pyyaml requests
      
      - name: Update templates
        run: python gradleInit.py templates --update
      
      - name: Generate kotlin-multi project
        run: |
          python gradleInit.py init test-multi \
            --template kotlin-multi \
            --group com.example
      
      - name: Build and test
        working-directory: test-multi
        run: |
          chmod +x gradlew
          ./gradlew clean build test --no-daemon

  # ==========================================================================
  # Job 5: Test multiproject-root with ALL templates as subprojects
  # ==========================================================================
  test-multiproject-full:
    name: Test Full Multiproject
    runs-on: ubuntu-latest
    needs: [test-single-templates, test-kotlin-multi]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install Python dependencies
        run: pip install jinja2 toml pyyaml requests
      
      - name: Update templates
        run: python gradleInit.py templates --update
      
      - name: Create multiproject-root
        run: |
          python gradleInit.py init enterprise-app \
            --template multiproject-root \
            --group com.enterprise
      
      - name: Add kotlin-single subproject (CLI core)
        run: |
          cd enterprise-app
          python ../gradleInit.py subproject core \
            --template kotlin-single \
            --group com.enterprise
      
      - name: Add kotlin-single-clikt subproject (CLI app)
        run: |
          cd enterprise-app
          python ../gradleInit.py subproject cli \
            --template kotlin-single \
            --config enable_clikt=true \
            --group com.enterprise
      
      - name: Add ktor subproject (API)
        run: |
          cd enterprise-app
          python ../gradleInit.py subproject api \
            --template ktor \
            --group com.enterprise
      
      - name: Add springboot subproject (Backend)
        run: |
          cd enterprise-app
          python ../gradleInit.py subproject backend \
            --template springboot \
            --group com.enterprise
      
      - name: Build entire multiproject
        working-directory: enterprise-app
        run: |
          chmod +x gradlew
          ./gradlew clean build --no-daemon
      
      - name: Test entire multiproject
        working-directory: enterprise-app
        run: |
          ./gradlew test --no-daemon
      
      - name: Build with Git info
        working-directory: enterprise-app
        run: |
          ./gradlew build -PenableGitInfo=true --no-daemon
      
      - name: Show project structure
        working-directory: enterprise-app
        run: |
          echo "=== Project Structure ==="
          find . -name "*.gradle.kts" -o -name "libs.versions.toml" | head -20
          echo ""
          echo "=== settings.gradle.kts ==="
          cat settings.gradle.kts

  # ==========================================================================
  # Job 6: Summary
  # ==========================================================================
  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [update-templates, test-single-templates, test-javafx, test-kotlin-multi, test-multiproject-full]
    if: always()
    
    steps:
      - name: Check results
        run: |
          echo "======================================"
          echo "  gradleInit CI Summary"
          echo "======================================"
          echo ""
          echo "Update Templates:    ${{ needs.update-templates.result }}"
          echo "Single Templates:    ${{ needs.test-single-templates.result }}"
          echo "JavaFX Template:     ${{ needs.test-javafx.result }}"
          echo "Kotlin-Multi:        ${{ needs.test-kotlin-multi.result }}"
          echo "Full Multiproject:   ${{ needs.test-multiproject-full.result }}"
          echo ""
          
          if [[ "${{ needs.test-multiproject-full.result }}" == "success" ]]; then
            echo "All tests passed!"
            exit 0
          else
            echo "Some tests failed!"
            exit 1
          fi
